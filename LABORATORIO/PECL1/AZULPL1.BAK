%************************************************************
%Estructuras de datos necesarias para el programa
%************************************************************
bolsa([
    'A','A','A','A','A','A','A','A','A','A','A','A','A','A','A','A','A','A','A','A',
    'B','B','B','B','B','B','B','B','B','B','B','B','B','B','B','B','B','B','B','B',
    'V','V','V','V','V','V','V','V','V','V','V','V','V','V','V','V','V','V','V','V',
    'R','R','R','R','R','R','R','R','R','R','R','R','R','R','R','R','R','R','R','R',
    'N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N','N']).
patron([
    ['_'],
    ['_','_'],
    ['_','_','_'],
    ['_','_','_','_'],
    ['_','_','_','_','_']
    ]).
mosaico([
    ['a','n','r','v','b'],
    ['b','a','n','r','v'],
    ['v','b','a','n','r'],
    ['r','v','b','a','n'],
    ['n','r','v','b','a']
    ]).
centroMesa([]).
cementerio([]).
caja([]).
tablero1([]).
tablero2([]).
tableroJuego([]).


%************************************************************
%Inicialización de las estructuras de datos
%************************************************************
ini_centroMesa(Centro):-centroMesa(Centro).
ini_caja(Caja):-caja(Caja).
ini_cementerio(Cementerio):-cementerio(Cementerio).
ini_bolsa(BolsaOut):-
    bolsa(Bolsa),
    random_permutation(Bolsa, BolsaOut).
ini_patron(Patron, PatronOut, Jugadores):-
    Jugadores > 0,
    patron(PatronX),
    append(Patron, [PatronX], Salida),
    JugadoresFinal is Jugadores - 1,
    ini_patron(Salida, PatronOut, JugadoresFinal).
ini_patron(Patron, Patron, 0).
ini_mosaico(Mosaico, MosaicoOut, Jugadores):-
    Jugadores > 0,
    mosaico(MosaicoX),
    append(Mosaico, [MosaicoX], Salida),
    JugadoresFinal is Jugadores - 1,
    ini_mosaico(Salida, MosaicoOut, JugadoresFinal).
ini_mosaico(Mosaico, Mosaico, 0).
ini_factoria(BolsaIn,BolsaOut,FactOut):-
    nth0(0, BolsaIn, Ficha1, BolsaAux1),
    nth0(0, BolsaAux1, Ficha2, BolsaAux2),
    nth0(0, BolsaAux2, Ficha3, BolsaAux3),
    nth0(0, BolsaAux3, Ficha4, BolsaOut),
    FactOut=[Ficha1,Ficha2,Ficha3,Ficha4].
ini_factorias(NFact,BolsaIn,BolsaOut,FactAux,FactOut):-
    NFact > 0,
    ini_factoria(BolsaIn,BolsaAux,FactoriaX),
    append(FactAux,[FactoriaX],Sublista),
    NFactOut is (NFact - 1),
    ini_factorias(NFactOut,BolsaAux,BolsaOut,Sublista,FactOut).
ini_factorias(0,BolsaOut,BolsaOut,FactOut,FactOut).
ini_factorias_njug(NJug,BolsaIn,BolsaOut,FactsOut):-
    NFacts is (NJug * 2) + 1,
    ini_factorias(NFacts,BolsaIn,BolsaOut,[],FactsOut).




%************************************************************
%Comienzo del programa
%************************************************************
jugarAzul():-
    iniciar(2,4).


%************************************************************
%Pide el número de jugadores del programa
%************************************************************
iniciar(Min,Max):-
    repeat,
    write('Introduce el numero de jugadores (2-4): '),

    read(Jugadores),
    ((Jugadores>=Min,Jugadores=<Max,!);
        writeln('Dato incorrecto, n jugadores entre 2 y 4.'),false),

    iniciar_juego(Jugadores).


%************************************************************
%Llama a las funciones para inicializar las estructuras de
%datos
%************************************************************
iniciar_juego(Jugadores):-
    write('Tablero inicializado con '),write(Jugadores),writeln(' jugadores'),

    ini_bolsa(Bolsa),
    ini_factorias_njug(Jugadores,Bolsa,BolsaOut,ListaFactorias),
    ini_centroMesa(Centro),
    ini_caja(Caja),
    ini_mosaico(_, MosaicoOut, Jugadores),
    ini_patron(_, PatronOut, Jugadores),
    ini_cementerio(Cementerio),

    append(ListaFactorias,[Centro],ListaFactoriasOut),
    Tablero1 = [Caja,BolsaOut, ListaFactoriasOut, Centro],
    Tablero2 = [PatronOut, MosaicoOut, Cementerio],
    Juego = [Tablero1,Tablero2],

    empezar_juego(Jugadores, Juego, Jugadores).


%************************************************************
%Donde se encuentran la mayoria de llamadas a funciones del
%programa, y donde se controlan los turnos de los jutgadores
%************************************************************
empezar_juego(Jugadores, Juego, Contador):-

    Contador > 0,

    Juego=[Tablero1, Tablero2],
    Tablero1=[_, Bolsa, Factorias, Centro],
    Tablero2=[PatronTodos, MosaicoTodos, Cementerio],

    writeln('********************'),
    write('Turno del jugador '), writeln(Contador),
    ContadorOut is Contador - 1,
    NJug is  (Jugadores * 2) + 1,

    %Annadimos el nuevo centro a lista de factorias
    replace_index(Factorias,NJug,Centro,FactoriasCentro),

    %Elegimos la factoria y el color que queremos escoger de esa factoria
    elegir_factoria(Centro, CentroOut, FactoriasCentro, FactoriaElegida, Elegida),
    elegir_color(FactoriaElegida, Color),

    length(FactoriaElegida, LongitudFactoria),

    %Segun el color se nos retornará dos lista una con las fichas sobrantes y otra con las que tienen
    %el color de la factoria correspondiente
    eleccion_color(FactoriaElegida, _, FichasCogidasOut, _, FichasSobrantesOut, LongitudFactoria, Color),

    %Vaciamos la factoria elegida
    ElegidaIndex is Elegida - 1,
    replace_index(FactoriasCentro, ElegidaIndex, [], FactoriasOut),

    %Cogemos el patron y mosaico del jugador que este jugando en ese momento y introducimos las fichas en
    %el patron y en el caso de necesitarlo se mete en el mosaico
    nth1(Contador, PatronTodos, Patron),
    nth1(Contador, MosaicoTodos, Mosaico),
    reemplazar_fichas(ElegidaIndex, NJug, FichasSobrantesOut, Centro, CentroOut),
    introducir_patron(Patron, PatronOut, FichasCogidasOut, Color, Mosaico, MosaicoOut, _, CajaOut),
    imprimir_patron(PatronOut),

    %Una vez cambiados el patron y mosaico del jugador lo reemplazamos por el que habia antes
    replace_index(PatronTodos, ContadorOut, PatronOut, PatronTodosOut),
    replace_index(MosaicoTodos, ContadorOut, MosaicoOut, MosaicoTodosOut),

    %Una vez hecho lo anterior comprobamos la longitud total de la lista de factorias y centro
    %y segun esta metemos las fichas que tenemos en la caja dentro para que el juego pueda continuar
    length(FactoriasOut, FactLong),
    length(CentroOut, Suma),
    FactLong1 is FactLong - 1,
    longitud_total(FactoriasOut, FactLong1, Suma, LongTotalOut),
    length(Bolsa, BolsaLong),
    llenar_bolsa(BolsaLong, CajaOut, CajaOutOut, Bolsa, BolsaOut),
    llenar_facts(LongTotalOut, FactoriasOut, FactoriasOutOut, BolsaOut, BolsaOutOut, Jugadores),

    %Reensamblamos todas las listas
    Tablero1Out = [CajaOutOut, BolsaOutOut, FactoriasOutOut, CentroOut],
    Tablero2Out = [PatronTodosOut, MosaicoTodosOut, Cementerio],
    JuegoOut = [Tablero1Out, Tablero2Out],

    writeln('********************'),
    empezar_juego(Jugadores, JuegoOut, ContadorOut).
empezar_juego(Jugadores, Juego, 0):- empezar_juego(Jugadores, Juego, Jugadores).


%************************************************************
%Llena la bolsa con las fichas de la caja
%************************************************************
llenar_bolsa(_, Caja, CajaOut, Bolsa, BolsaOut):-
    append(Bolsa, Caja, BolsaOut),
    CajaOut = [].


%************************************************************
%Llena las factorias cuando se han vaciado
%************************************************************
llenar_facts(0, _, FactoriasOutOut, Bolsa, BolsaOut, Jugadores):-
    ini_factorias_njug(Jugadores,Bolsa,BolsaOut,ListaFactorias),
    append(ListaFactorias,[[]],FactoriasOutOut).
llenar_facts(_, FactoriasOut, FactoriasOut, Bolsa, Bolsa, _).



%************************************************************
%Mete las fichas sobrantes en el centro (si es sobrantes de
%una factoria) o no las mete (sobrantes de centro)
%************************************************************o
reemplazar_fichas(X,X,FichasSobrantesOut, _, CentroOut):-
    append([],FichasSobrantesOut, CentroOut).
reemplazar_fichas(_,_,FichasSobrantesOut, Centro, CentroOut):-
    append(Centro, FichasSobrantesOut, CentroOut).


%************************************************************
%Pide un número de factoria elegido por el usuario
%************************************************************
elegir_factoria(Centro, _, Factorias, FactoriaElegida, Elegida):-

    length(Factorias, Long),
    Longitud is Long - 1,

    imprimir_factorias(Factorias, 0, Longitud),

    write(Long),write('C. '),writeln(Centro),

    pedir_n_factoria(Elegida,Longitud, Factorias),
    Index is Elegida - 1,
    nth0(Index, Factorias, FactoriaElegida),
    write('Elegida factoria '),write(Elegida),write(' '),writeln(FactoriaElegida).


%************************************************************
%Pide el número de patron y mete las fichas elegidas por el
%en el patron
%************************************************************
introducir_patron(Patron, PatronOut, FichasCogidas, Color, Mosaico, MosaicoOut,Caja, CajaOut):-

    imprimir_patron(Patron),

    write('Elige donde quieres colocar '),writeln(FichasCogidas),

    elegir_patron(1, 5, NPatron, Patron, Color),

    nth1(NPatron, Patron, PatronElegido),

    length(FichasCogidas, LongitudCogidas),

    count(Color, PatronElegido, NElementos),

    %Son los huecos dentro de la línea del patrón donde podemos meter fichas
    HuecosLibres is NPatron - NElementos,

    reemplazar_patron(NPatron, LongitudCogidas, HuecosLibres, PatronElegido, PatronElegidoOut, Color, Mosaico, MosaicoOut),
    count(Color, PatronElegidoOut, Lleno),
    comprobar_linea(NPatron,Lleno,PatronElegidoOut,PatronElegidoOut1,Mosaico,MosaicoOut,Color,Caja,CajaOut),
    PatronIndex is NPatron - 1,
    replace_index(Patron, PatronIndex, PatronElegidoOut1, PatronOut).


%************************************************************
%Segun los huecos libres que tenga la linea de patron donde
%se va a introducir las fichas tendra diferente comportamiento
%************************************************************
reemplazar_patron(NPatron,LongitudCogidas, HuecosLibres, PatronElegido, PatronElegidoOut, Color, Mosaico, MosaicoOut):-
    %Cuando hay mas huecos que fichas vas a meter
    HuecosLibres > LongitudCogidas,
    append([Color], PatronElegido, PatronElegidoAux),
    remove('_', PatronElegidoAux, PatronElegidoAux1),
    LongitudCogidas2 is LongitudCogidas-1,
    reemplazar_patron(NPatron, LongitudCogidas2, HuecosLibres, PatronElegidoAux1, PatronElegidoOut, Color, Mosaico, MosaicoOut).
reemplazar_patron(_,LongitudCogidas, HuecosLibres, PatronElegido, PatronElegidoOut, Color, _, _):-
    %Cuando hay igual o mas fichas que huecos
    HuecosLibres =< LongitudCogidas,
    replace('_',Color,PatronElegido,PatronElegidoOut).
reemplazar_patron(_,0, _, PatronElegido, PatronElegido, _, _, _).


%************************************************************
%Dependiendo de si esta llena o no la linea de patron mete
%la ficha en el mosaico y las sobrantes en la caja
%************************************************************
comprobar_linea(NPatron, NPatron, PatronElegido, PatronElegidoOut, Mosaico, MosaicoOut, Color, Caja, CajaOut):-
    introducir_mosaico(NPatron, Mosaico, MosaicoOut, Color),
    replace(Color, '_', PatronElegido, PatronElegidoOut),
    meter_caja(NPatron, Caja, CajaOut, Color).
comprobar_linea(_, _, PatronElegido, PatronElegido, Mosaico, Mosaico, _, _, _).


%************************************************************
%Mete las fichas sobrantes de pasar de la linea de patron al
%mosaico
%************************************************************
meter_caja(Fichas, Caja, CajaOut, Color):-
    Fichas > 1,
    append([Color], Caja, CajaAux),
    FichasAux is Fichas - 1,
    meter_caja(FichasAux, CajaAux, CajaOut, Color).
meter_caja(1, Caja, Caja, _).


%************************************************************
%Devuelve la suma de la longitud de todoas las factorias
%************************************************************
longitud_total(Factorias, LongFactorias, LongTotal, LongTotalOut):-
    LongFactorias > 0,
    nth1(LongFactorias, Factorias, FactoriaActual),
    length(FactoriaActual, Sumando),
    LongTotal1 is LongTotal + Sumando,
    LongFactorias1 is LongFactorias - 1,
    longitud_total(Factorias, LongFactorias1, LongTotal1, LongTotalOut).
longitud_total(_, 0, LongTotal, LongTotal).


%************************************************************
%Imprime el patrón de juego
%************************************************************
imprimir_patron(Patron):-
    Patron = [Patron1, Patron2, Patron3, Patron4, Patron5],
    write('1. '), writeln(Patron1),
    write('2. '), writeln(Patron2),
    write('3. '), writeln(Patron3),
    write('4. '), writeln(Patron4),
    write('5. '), writeln(Patron5).


%************************************************************
%Imprime el patrón de juego
%************************************************************
imprimir_mosaico(Mosaico):-
    writeln('Asi queda el mosaico'),
    Mosaico = [Mosaico1, Mosaico2, Mosaico3, Mosaico4, Mosaico5],
    writeln(Mosaico1),
    writeln(Mosaico2),
    writeln(Mosaico3),
    writeln(Mosaico4),
    writeln(Mosaico5).


%************************************************************
%Segun el color y la linea de patron que se ha completado
%introduce en esa linea y en la posición del color
%de esa linea del mosaico, la ficha correspondiente
%************************************************************
introducir_mosaico(NPatron, Mosaico, MosaicoOut, 'R'):-
    nth1(NPatron, Mosaico, LineaMosaico),
    replace('r','R',LineaMosaico,LineaMosaicoOut),
    replace(LineaMosaico,LineaMosaicoOut,Mosaico,MosaicoOut),
    imprimir_mosaico(MosaicoOut).
introducir_mosaico(NPatron, Mosaico, MosaicoOut, 'A'):-
    nth1(NPatron, Mosaico, LineaMosaico),
    replace('a','A',LineaMosaico,LineaMosaicoOut),
    replace(LineaMosaico,LineaMosaicoOut,Mosaico,MosaicoOut),
    imprimir_mosaico(MosaicoOut).
introducir_mosaico(NPatron, Mosaico, MosaicoOut, 'B'):-
    nth1(NPatron, Mosaico, LineaMosaico),
    replace('b','B',LineaMosaico,LineaMosaicoOut),
    replace(LineaMosaico,LineaMosaicoOut,Mosaico,MosaicoOut),
    imprimir_mosaico(MosaicoOut).
introducir_mosaico(NPatron, Mosaico, MosaicoOut, 'V'):-
    nth1(NPatron, Mosaico, LineaMosaico),
    replace('v','V',LineaMosaico,LineaMosaicoOut),
    replace(LineaMosaico,LineaMosaicoOut,Mosaico,MosaicoOut),
    imprimir_mosaico(MosaicoOut).
introducir_mosaico(NPatron, Mosaico, MosaicoOut, 'N'):-
    nth1(NPatron, Mosaico, LineaMosaico),
    replace('n','N',LineaMosaico,LineaMosaicoOut),
    replace(LineaMosaico,LineaMosaicoOut,Mosaico,MosaicoOut),
    imprimir_mosaico(MosaicoOut).


%************************************************************
%Imprime todas las factorías que hay en el tablero
%************************************************************
imprimir_factorias(Factorias,NFactoria,Longitud):-
    NFactoria < Longitud,
    nth0(NFactoria, Factorias, FactoriaWrite, _),

    Num is NFactoria + 1,
    write(Num),write('.  '),writeln(FactoriaWrite),

    imprimir_factorias(Factorias, Num, Longitud).
imprimir_factorias(_,_,_).


%************************************************************
%Pide un número de factoria elegido por el usuario
%************************************************************
pedir_n_factoria(Elegida, NFactorias, Factorias):-
    repeat,
    write('Introduce el numero de factoria: '),

    read(Elegida),
    nth1(Elegida, Factorias, FactElegida),
    length(FactElegida, Longitud),
    NFactoriasOut is NFactorias + 2,
    ((Elegida>=1,Elegida=<NFactoriasOut,Longitud>=1,!);
        writeln('ERROR: Color de factoria no valido'),
        writeln('       o factoria vacia'),false).


%************************************************************
%Con la factoría elegida y el color que queremos nos
%retorna una lista con las fichas a colocar
%************************************************************
eleccion_color([Color|Restantes], FichasCogidas, FichasCodigasOut, FichasSobrantes, FichasSobrantesOut, Contador, Color):-
    Contador > 0,
    ContadorOut is Contador - 1,
    append([Color], FichasCogidas, FichasCogidas1),
    eleccion_color(Restantes, FichasCogidas1, FichasCodigasOut, FichasSobrantes, FichasSobrantesOut, ContadorOut, Color).
eleccion_color([Ficha|Restantes], FichasCogidas, FichasCodigasOut, FichasSobrantes, FichasSobrantesOut, Contador, Color):-
    Contador > 0,
    ContadorOut is Contador - 1,
    append([Ficha], FichasSobrantes, FichasSobrantes1),
    eleccion_color(Restantes, FichasCogidas, FichasCodigasOut, FichasSobrantes1, FichasSobrantesOut, ContadorOut, Color).
eleccion_color([], FichasCodigas, FichasCodigas, FichasSobrantes, FichasSobrantes, 0, _).


%************************************************************
%Sirve para elegir un color de la lista elegida
%************************************************************
elegir_color(FactoriaElegida, Color):-
    repeat,
    write('Introduce el color quieres elegir: '),

    read(Color),
    ((member(Color, FactoriaElegida),!);
        writeln('ERROR: Color de factoria no valido'),false).


%************************************************************
%Elige la línea de patron que quiere el usuario pero con
%restricciones de color
%************************************************************
%** A **
elegir_patron(Min,Max,NPatron,Patron,'A'):-
    repeat,
    write('Introduce el numero de patron (1-5): '),

    read(NPatron),
    nth1(NPatron, Patron, PatronElegido),
    (((NPatron>=Min),(NPatron=<Max),
        \+ member('B',PatronElegido),\+ member('R',PatronElegido),
        \+ member('V',PatronElegido),\+ member('N',PatronElegido),!);
        writeln('ERROR: numero de patron entre 1 y 5.'),
        writeln('       o color incorrecto para la linea de patron.'),false).
%** B **
elegir_patron(Min,Max,NPatron,Patron,'B'):-
    repeat,
    write('Introduce el numero de patron (1-5): '),

    read(NPatron),
    nth1(NPatron, Patron, PatronElegido),
    ((NPatron>=Min,NPatron=<Max,
        \+ member('A',PatronElegido),\+ member('R',PatronElegido),
        \+ member('V',PatronElegido),\+ member('N',PatronElegido),!);
        writeln('ERROR: numero de patron entre 1 y 5.'),
        writeln('       o color incorrecto para la linea de patron.'),false).
%** R **
elegir_patron(Min,Max,NPatron,Patron,'R'):-
    repeat,
    write('Introduce el numero de patron (1-5): '),

    read(NPatron),
    nth1(NPatron, Patron, PatronElegido),
    ((NPatron>=Min,NPatron=<Max,
        \+ member('A',PatronElegido),\+ member('B',PatronElegido),
        \+ member('V',PatronElegido),\+ member('N',PatronElegido),!);
        writeln('ERROR: numero de patron entre 1 y 5.'),
        writeln('       o color incorrecto para la linea de patron.'),false).
%** V **
elegir_patron(Min,Max,NPatron,Patron,'V'):-
    repeat,
    write('Introduce el numero de patron (1-5): '),

    read(NPatron),
    nth1(NPatron, Patron, PatronElegido),
    ((NPatron>=Min,NPatron=<Max,
        \+ member('A',PatronElegido),\+ member('R',PatronElegido),
        \+ member('B',PatronElegido),\+ member('N',PatronElegido),!);
        writeln('ERROR: numero de patron entre 1 y 5.'),
        writeln('       o color incorrecto para la linea de patron.'),false).
%** N **
elegir_patron(Min,Max,NPatron,Patron,'N'):-
    repeat,
    write('Introduce el numero de patron (1-5): '),

    read(NPatron),
    nth1(NPatron, Patron, PatronElegido),
    ((NPatron>=Min,NPatron=<Max,
        \+ member('A',PatronElegido),\+ member('R',PatronElegido),
        \+ member('V',PatronElegido),\+ member('B',PatronElegido),!);
        writeln('ERROR: numero de patron entre 1 y 5.'),
        writeln('       o color incorrecto para la linea de patron.'),false).


%************************************************************
%Reemplaza el elemento en la posición index por otro elemento
%************************************************************
replace_index([_|T], 0, X, [X|T]).
replace_index([H|T], I, X, [H|R]):-
    I > -1,
    NI is I-1,
    replace_index(T, NI, X, R), !.
replace_index(L, _, _, L).


%************************************************************
%Cuenta las apariciones de un elemento en una lista
%************************************************************
count(_, [], 0).
count(X, [X | T], N) :-
    !, count(X, T, N1),
    N is N1 + 1.
count(X, [_ | T], N) :-
    count(X, T, N).


%************************************************************
%Reemplaza las posiciones que tienen por otro
%  X-Elemento reemplazado, Y-Elemento que reemplaza
%************************************************************
replace(_, _, [], []).
replace(X, Y, [X|T], [Y|T2]):-
    replace(X, Y, T, T2).
replace(X, Y, [H|T], [H|T2]):-
    H \= X, replace(X, Y, T, T2).


%************************************************************
%Borra la primera aparición del elemento en la lista
%************************************************************
remove(X, [X|Xs], Xs).
remove(X, [Y|Ys], [Y|Zs]):-
    remove(X, Ys, Zs).
