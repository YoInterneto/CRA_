
%Listas para cada uno de los tableros usados en el programa
bolsa([
    'A','A','A','A','A','A','A','A','A','A',
    'B','B','B','B','B','B','B','B','B','B',
    'V','V','V','V','V','V','V','V','V','V',
    'R','R','R','R','R','R','R','R','R','R',
    'N','N','N','N','N','N','N','N','N','N']).
patron([
    ['_'],
    ['_','_'],
    ['_','_','_'],
    ['_','_','_','_'],
    ['_','_','_','_','_']
    ]).
mosaico([
    ['a','n','r','v','b'],
    ['b','a','n','r','v'],
    ['v','b','a','n','r'],
    ['r','v','b','a','n'],
    ['n','r','v','b','a']
    ]).
centroMesa([]).
cementerio([]).
caja([]).
tablero1([]).
tablero2([]).
tableroJuego([]).


%Inicializacion de las listas que usaran en el programa
ini_bolsa(BolsaOut):-bolsa(Bolsa),random_permutation(Bolsa, BolsaOut).


ini_centroMesa(Centro):-centroMesa(Centro).


ini_mosaico(Mosaico):-mosaico(Mosaico).


ini_caja(Caja):-caja(Caja).


ini_patron(Patron):-patron(Patron).


ini_cementerio(Cementerio):-cementerio(Cementerio).


ini_factoria(BolsaIn,BolsaOut,FactOut):-
    nth0(0, BolsaIn, Ficha1, BolsaAux1),
    nth0(0, BolsaAux1, Ficha2, BolsaAux2),
    nth0(0, BolsaAux2, Ficha3, BolsaAux3),
    nth0(0, BolsaAux3, Ficha4, BolsaOut),
    FactOut=[Ficha1,Ficha2,Ficha3,Ficha4].


ini_factorias(NFact,BolsaIn,BolsaOut,FactAux,FactOut):-
    NFact > 0,
    ini_factoria(BolsaIn,BolsaAux,FactoriaX),
    append(FactAux,[FactoriaX],Sublista),
    NFactOut is (NFact - 1),
    ini_factorias(NFactOut,BolsaAux,BolsaOut,Sublista,FactOut).
ini_factorias(0,BolsaOut,BolsaOut,FactOut,FactOut).


ini_factorias_njug(NJug,BolsaIn,BolsaOut,FactsOut):-
    NFacts is (NJug * 2) + 1,
    ini_factorias(NFacts,BolsaIn,BolsaOut,[],FactsOut).



%Logica del programa
jugarAzul():-
    iniciar(2,4,Jugadores).


iniciar(Min,Max,Jugadores):-
    repeat,
    write('Introduce el numero de jugadores (2-4): '),

    read(Jugadores),
    ((Jugadores>=Min,Jugadores=<Max,!);
        writeln('Dato incorrecto, n jugadores entre 2 y 4.'),false),
        
    iniciar_juego(Jugadores).


iniciar_juego(Jugadores):-
    write('Tablero inicializado con '),write(Jugadores),writeln(' jugadores'),
    
    ini_bolsa(Bolsa),
    ini_factorias_njug(Jugadores,Bolsa,BolsaOut,ListaFactorias),
    ini_centroMesa(Centro),
    ini_patron(Patron),
    ini_caja(Caja),
    ini_mosaico(Mosaico),
    ini_cementerio(Cementerio),
    
    Tablero1 = [Caja,BolsaOut,ListaFactorias,Centro],
    Tablero2 = [Patron,Mosaico,Cementerio],
    Juego = [Tablero1,Tablero2],

    empezar_juego(Jugadores,Juego).


empezar_juego(Jugadores,Juego):-

    Juego=[Tablero1,Tablero2],
    Tablero1=[Caja,Bolsa,Factorias,Centro],
    Tablero2=[Patron,Mosaico,Cementerio],

    write('Turno del jugador '), writeln(Jugadores),
    writeln(Factorias),

    elegir_factoria(Centro, CentroOut, Factorias, FactoriaElegida, Elegida),
    elegir_color(FactoriaElegida, Color),
    length(FactoriaElegida, LongitudFactoria),
    eleccion_color(FactoriaElegida, FichasCogidas, FichasCogidasOut, FichasSobrantes, FichasSobrantesOut, LongitudFactoria, Color),
    
    ElegidaIndex is Elegida - 1,
    replace_index(Factorias, ElegidaIndex, [], FactoriasOut),
    
    %regla para comprobar si todas las factorias son vacias y si son vacias que las llene ini_factorias_njug(NJug,BolsaIn,BolsaOut,FactsOut):-
    %********
    
    introducir_patron(Patron, PatronOut, FichasCogidasOut, Color, Mosaico, MosaicoOut).
    
    
    
%Muestra y pide al usuario que diga la factoria/centro que quiere elegir
%Poner algo asi para hacer un IF??????
elegir_factoria(Centro, CentroOut, Factorias, FactoriaElegida, Elegida):-

    length(Factorias, Long),
    Longitud is Long + 1,
    
    imprimir_factorias(Factorias, 0, Longitud),
    
    C is Longitud + 1,
    write(Longitud),write('C. '),writeln(Centro),

    pedir_n_factoria(Elegida,Longitud),
    Index is Elegida - 1,
    nth0(Index, Factorias, FactoriaElegida),
    write('Elegida factoria '),write(Index),write(' '),writeln(FactoriaElegida).
    
introducir_patron(Patron, PatronOut, FichasCogidas, Color, Mosaico, MosaicoOut):-

    imprimir_patron(Patron),
    elegir_patron(1, 5, NPatron, Patron, Color),
    
    nth1(NPatron, Patron, PatronElegido),
    
    length(FichasCogidas, LongitudCogidas),
    write(LongitudCogidas),
    writeln(NPatron),
    
    count(Color, PatronElegido, NElementos),
    count('_', PatronElegido, NVacios),
    
    writeln(NElementos),
    %Son los huecos dentro de la linea del patron donde podemos meter fichas
    HuecosLibres is NPatron - NElementos,
    
    reemplazar_patron(NPatron, LongitudCogidas, HuecosLibres, PatronElegido, PatronElegidoOut, Color, Mosaico, MosaicoOut),
    writeln(PatronElegidoOut),
    writeln(MosaicoOut).
    
reemplazar_patron(NPatron,LongitudCogidas, HuecosLibres, PatronElegido, PatronElegidoOut, Color, Mosaico, MosaicoOut):-
    %Cuando hay mas huecos que fichas vas a meter
    HuecosLibres > LongitudCogidas,
    LongitudCogidas >0,
    writeln('Sobran huecos'),
    append([Color], PatronElegido, PatronElegidoAux),
    remove('_', PatronElegidoAux, PatronElegidoAux1),
    LongitudCogidas2 is LongitudCogidas-1,
    reemplazar_patron(NPatron, LongitudCogidas2, HuecosLibres, PatronElegidoAux1, PatronElegidoOut, Color, Mosaico, MosaicoOut).

reemplazar_patron(NPatron,0, HuecosLibres, PatronElegido, PatronElegido, Color, Mosaico, MosaicoOut).

reemplazar_patron(NPatron,LongitudCogidas, HuecosLibres, PatronElegido, PatronElegidoOut, Color, Mosaico, MosaicoOut):-
    %Cuando hay igual o mas fichas que huecos
    HuecosLibres > 0,
    append([Color], PatronElegido, PatronElegidoAux),
    remove('_', PatronElegidoAux, PatronElegidoAux1),
    HuecosLibres2 is HuecosLibres-1,
    reemplazar_patron(NPatron, LongitudCogidas, HuecosLibres2, PatronElegidoAux1, PatronElegidoOut, Color, Mosaico, MosaicoOut).

reemplazar_patron(NPatron,LongitudCogidas, 0, PatronElegido, PatronElegido, Color, Mosaico, MosaicoOut):-
    introducir_mosaico(NPatron, Mosaico, MosaicoOut, Color).



    
    

    


imprimir_patron(Patron):-
    Patron = [Patron1, Patron2, Patron3, Patron4, Patron5],
    write('1. '), writeln(Patron1),
    write('2. '), writeln(Patron2),
    write('3. '), writeln(Patron3),
    write('4. '), writeln(Patron4),
    write('5. '), writeln(Patron5).
    

%Esta funcion lo que hace es unificar la longitud de la linea patron con el numero de fichas de un color
%que hay en un mosaico, si son iguales introducira en la linea NPatron del mosaico la ficha del color, si no
%no hace nada
%Posiblmente hacer una regla para cada color
introducir_mosaico(NPatron, Mosaico, MosaicoOut, 'R'):-
    writeln('iguales'),
    nth1(NPatron, Mosaico, LineaMosaico),
    replace('r','R',LineaMosaico,LineaMosaicoOut),
    replace(LineaMosaico,LineaMosaicoOut,Mosaico,MosaicoOut).

introducir_mosaico(NPatron, Mosaico, MosaicoOut, 'A'):-
    writeln('iguales'),
    nth1(NPatron, Mosaico, LineaMosaico),
    replace('a','A',LineaMosaico,LineaMosaicoOut),
    replace(LineaMosaico,LineaMosaicoOut,Mosaico,MosaicoOut).
    
introducir_mosaico(NPatron, Mosaico, MosaicoOut, 'B'):-
    writeln('iguales'),
    nth1(NPatron, Mosaico, LineaMosaico),
    replace('b','B',LineaMosaico,LineaMosaicoOut),
    replace(LineaMosaico,LineaMosaicoOut,Mosaico,MosaicoOut).
    
introducir_mosaico(NPatron, Mosaico, MosaicoOut, 'V'):-
    writeln('iguales'),
    nth1(NPatron, Mosaico, LineaMosaico),
    replace('v','V',LineaMosaico,LineaMosaicoOut),
    replace(LineaMosaico,LineaMosaicoOut,Mosaico,MosaicoOut).
    
introducir_mosaico(NPatron, Mosaico, MosaicoOut, 'N'):-
    writeln('iguales'),
    nth1(NPatron, Mosaico, LineaMosaico),
    replace('n','N',LineaMosaico,LineaMosaicoOut),
    replace(LineaMosaico,LineaMosaicoOut,Mosaico,MosaicoOut).

   



%introducir_mosaico(NPatron, Mosaico, MosaicoOut,'R'):-
 %  writeln('no iguales').
    

%Imprime todas las factorias que hay en el tablero
imprimir_factorias(Factorias,NFactoria,Longitud):-
    NFactoria < Longitud,
    nth0(NFactoria, Factorias, FactoriaWrite, FactoriasOut),

    Num is NFactoria + 1,
    write(Num),write('.  '),writeln(FactoriaWrite),

    imprimir_factorias(Factorias, Num, Longitud).
imprimir_factorias(Factorias,NFactoria,Longitud).



%************************************************************
%Pide un numero de factoria elegido por el usuario
%************************************************************
pedir_n_factoria(Elegida,NFactorias):-
    repeat,
    write('Introduce el numero de factoria: '),

    read(Elegida),
    ((Elegida>=1,Elegida=<NFactorias,!);
        writeln('ERROR: Color de factoria no valido'),false).
        
        
%************************************************************
%Con la factoria elegida y el color que queremos nos
%retorna una lista con las fichas a colocar
%************************************************************
eleccion_color([Color|Restantes], FichasCogidas, FichasCodigasOut, FichasSobrantes, FichasSobrantesOut, Contador, Color):-
    Contador > 0,
    writeln('Si'),
    ContadorOut is Contador - 1,
    append([Color], FichasCogidas, FichasCogidas1),
    eleccion_color(Restantes, FichasCogidas1, FichasCodigasOut, FichasSobrantes, FichasSobrantesOut, ContadorOut, Color).
eleccion_color([Ficha|Restantes], FichasCogidas, FichasCodigasOut, FichasSobrantes, FichasSobrantesOut, Contador, Color):-
    Contador > 0,
    writeln('No'),
    ContadorOut is Contador - 1,
    append([Ficha], FichasSobrantes, FichasSobrantes1),
    eleccion_color(Restantes, FichasCogidas, FichasCodigasOut, FichasSobrantes1, FichasSobrantesOut, ContadorOut, Color).
eleccion_color([], FichasCodigas, FichasCodigas, FichasSobrantes, FichasSobrantes, 0, Color).



%************************************************************
%Sirve para elegir un color de la lista elegida
%************************************************************
elegir_color(FactoriaElegida, Color):-
    repeat,
    write('Introduce el color quieres elegir: '),

    read(Color),
    ((member(Color, FactoriaElegida),!);
        writeln('ERROR: Color de factoria no valido'),false).


        
%************************************************************
%Elige la linea que quiere el usuario pero con restricciones
%************************************************************

%** A **
elegir_patron(Min,Max,NPatron,Patron,'A'):-
    repeat,
    write('Introduce el numero de patron (1-5): '),

    read(NPatron),
    nth1(NPatron, Patron, PatronElegido),
    (((NPatron>=Min),(NPatron=<Max),
        \+ member('B',PatronElegido),\+ member('R',PatronElegido),
        \+ member('V',PatronElegido),\+ member('N',PatronElegido),!);
        writeln('ERROR: numero de patron entre 1 y 5.'),
        writeln('       o color incorrecto para la linea de patron.'),false).
        
%** B **
elegir_patron(Min,Max,NPatron,Patron,'B'):-
    repeat,
    write('Introduce el numero de patron (1-5): '),

    read(NPatron),
    nth1(NPatron, Patron, PatronElegido),
    ((NPatron>=Min,NPatron=<Max,
        \+ member('A',PatronElegido),\+ member('R',PatronElegido),
        \+ member('V',PatronElegido),\+ member('N',PatronElegido),!);
        writeln('ERROR: numero de patron entre 1 y 5.'),
        writeln('       o color incorrecto para la linea de patron.'),false).
        
%** R **
elegir_patron(Min,Max,NPatron,Patron,'R'):-
    repeat,
    write('Introduce el numero de patron (1-5): '),

    read(NPatron),
    nth1(NPatron, Patron, PatronElegido),
    ((NPatron>=Min,NPatron=<Max,
        \+ member('A',PatronElegido),\+ member('B',PatronElegido),
        \+ member('V',PatronElegido),\+ member('N',PatronElegido),!);
        writeln('ERROR: numero de patron entre 1 y 5.'),
        writeln('       o color incorrecto para la linea de patron.'),false).
        
%** V **
elegir_patron(Min,Max,NPatron,Patron,'V'):-
    repeat,
    write('Introduce el numero de patron (1-5): '),

    read(NPatron),
    nth1(NPatron, Patron, PatronElegido),
    ((NPatron>=Min,NPatron=<Max,
        \+ member('A',PatronElegido),\+ member('R',PatronElegido),
        \+ member('B',PatronElegido),\+ member('N',PatronElegido),!);
        writeln('ERROR: numero de patron entre 1 y 5.'),
        writeln('       o color incorrecto para la linea de patron.'),false).
        
%** N **
elegir_patron(Min,Max,NPatron,Patron,'N'):-
    repeat,
    write('Introduce el numero de patron (1-5): '),

    read(NPatron),
    nth1(NPatron, Patron, PatronElegido),
    ((NPatron>=Min,NPatron=<Max,
        \+ member('A',PatronElegido),\+ member('R',PatronElegido),
        \+ member('V',PatronElegido),\+ member('B',PatronElegido),!);
        writeln('ERROR: numero de patron entre 1 y 5.'),
        writeln('       o color incorrecto para la linea de patron.'),false).


        
%************************************************************
%Reemplaza el elemento en la posicion index por otro elemento
%************************************************************

replace_index([_|T], 0, X, [X|T]).
replace_index([H|T], I, X, [H|R]):-
    I > -1,
    NI is I-1,
    replace_index(T, NI, X, R), !.
replace_index(L, _, _, L).



%************************************************************
%Cuenta las apariciones de un elemento en una lista
%************************************************************
count(_, [], 0).
count(X, [X | T], N) :-
    !, count(X, T, N1),
    N is N1 + 1.
count(X, [_ | T], N) :-
    count(X, T, N).

    
    
%************************************************************
%Reemplaza las posiciones que tienen por otro
%  X-Elemento reemplazado, Y-Elemento que reemplaza
%************************************************************
replace(_, _, [], []).
replace(X, Y, [X|T], [Y|T2]):-
    replace(X, Y, T, T2).
replace(X, Y, [H|T], [H|T2]):-
    H \= X, replace(X, Y, T, T2).
    
    
%************************************************************
%Borra la primera aparicion del elemento en la lista
%************************************************************
remove(X, [X|Xs], Xs).
remove(X, [Y|Ys], [Y|Zs]):-
    remove(X, Ys, Zs).
    
replace(_, _, [], []).
replace(O, R, [O|T], [R|T2]) :- replace(O, R, T, T2).
replace(O, R, [H|T], [H|T2]) :- H \= O, replace(O, R, T, T2).

    